{% extends "ui/base.html" %}
{% block title %}已綁定使用者{% endblock %}
{% block header %}已綁定的使用者{% endblock %}

{% block content %}
<div class="card">
  <h3>使用者列表</h3>
  <table class="table">
      <thead>
        <tr>
          <th>Email</th>
          <th>User Name</th>
          <th>綁定時間</th>
          <th>上次上線</th>
        </tr>
      </thead>
      <tbody id="user-table-body">
        <tr>
          <td colspan="4">載入中...</td>
        </tr>
      </tbody>
    </table>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const tableBody = document.getElementById("user-table-body");
        const apiEndpoint = "{% url 'api_user_bound' %}";

        const renderMessage = (text) => {
            tableBody.innerHTML = "";
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 4;
            cell.textContent = text;
            row.appendChild(cell);
            tableBody.appendChild(row);
        };

        const formatValue = (value) => value ? value : "-";

        const formatTimestamp = (value) => {
            if (!value) {
                return "-";
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            const formatter = new Intl.DateTimeFormat("zh-TW", {
                timeZone: "Asia/Taipei",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
            });
            return formatter.format(date);
        };

        fetch(apiEndpoint, { credentials: "same-origin" })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (!ok) {
                    const errorText = data && data.error ? data.error : "載入失敗";
                    renderMessage(errorText);
                    return;
                }

                const items = Array.isArray(data.items) ? data.items : [];
                if (!items.length) {
                    renderMessage("目前沒有綁定使用者");
                    return;
                }

                tableBody.innerHTML = "";
                items.forEach((user, index) => {
                    const row = document.createElement("tr");

                    const emailCell = document.createElement("td");
                    emailCell.textContent = formatValue(user.email);
                    row.appendChild(emailCell);

                    const nameCell = document.createElement("td");
                    nameCell.textContent = formatValue(user.user_name);
                    row.appendChild(nameCell);

                    const bindAtCell = document.createElement("td");
                    bindAtCell.textContent = formatTimestamp(user.bind_at);
                    row.appendChild(bindAtCell);

                    const lastOnlineCell = document.createElement("td");
                    lastOnlineCell.textContent = formatTimestamp(user.last_online);
                    row.appendChild(lastOnlineCell);

                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error("Failed to load bound users:", error);
                renderMessage("載入失敗，請稍後再試");
            });
    });
    </script>
</div>
{% endblock %}
