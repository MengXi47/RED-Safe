{% extends "ui/base.html" %}
{% block title %}攝影機管理{% endblock %}
{% block header %}攝影機管理{% endblock %} {% block content %}
<style>
  /* ===== Cameras page scoped styles ===== */
  #cam-page .tbl {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 720px;
  }
  #cam-page .tbl th,
  #cam-page .tbl td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--line);
    text-align: left;
  }
  #cam-page .tbl th,
  #cam-page .tbl td {
    vertical-align: middle;
  }
  #cam-page .tbl td .chip,
  #cam-page .tbl td button.action-btn {
    display: inline-flex;
    align-items: center;
  }
  #cam-page .tbl th {
    height: 48px;
    line-height: 48px;
  }
  #cam-page .tbl td {
    height: 48px;
    line-height: 1.4;
  }
  #cam-page .tbl thead th {
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    font-size: 12px;
    text-transform: uppercase;
    /* keep headers on one line and avoid CJK splitting */
    white-space: nowrap;
    word-break: keep-all;
    /* reduce spacing to avoid unintended wraps */
    letter-spacing: 0.02em;
  }
  @media (prefers-color-scheme: dark) {
    #cam-page .tbl thead th {
      background: rgba(17, 24, 39, 0.55);
    }
  }

#cam-page .tbl thead th,
#cam-page .tbl thead th * {
  overflow-wrap: normal;
}
  #cam-page .tbl tbody tr:hover {
    background: rgba(255, 255, 255, 0.06);
  }
  #cam-page .tbl tbody tr.is-bound {
    opacity: 0.8;
  }
  #cam-page .tbl tbody tr.is-bound:hover {
    background: rgba(96, 165, 250, 0.08);
  }

  #cam-page .num {
    width: 64px;
    text-align: center;
  }
  #cam-page .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border: 1px solid var(--line);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.45);
  }
  @media (prefers-color-scheme: dark) {
    #cam-page .chip {
      background: rgba(255, 255, 255, 0.06);
    }
  }
  #cam-page .chip .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #60a5fa;
    box-shadow: 0 0 8px rgba(96, 165, 250, 0.6);
  }
  #cam-page .chip.mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", monospace;
  }

  #cam-page .actions {
    white-space: nowrap;
    display: flex;
    gap: 8px;
  }
  #cam-page .col-actions {
    width: 160px;
  }
  #cam-page .tbl .actions {
    justify-content: flex-start;
  }
  #cam-page .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: transparent;
    cursor: pointer;
  }
  #cam-page .action-btn:hover {
    background: rgba(255, 255, 255, 0.08);
  }
  #cam-page .action-btn[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
    background: transparent;
  }
  #cam-page .action-btn.danger {
    border-color: transparent;
    background: linear-gradient(
      180deg,
      var(--danger),
      calc(100% - 1px),
      #e34b50
    );
    color: #fff;
  }
  #cam-page .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    letter-spacing: 0.02em;
    background: rgba(96, 165, 250, 0.16);
    color: #1d4ed8;
    margin-left: 8px;
  }
  #cam-page .tbl tbody tr.is-bound .status-badge {
    background: rgba(52, 211, 153, 0.18);
    color: #047857;
  }
  #cam-page .tbl tbody tr.is-bound .chip .dot {
    background: #34d399;
    box-shadow: 0 0 6px rgba(52, 211, 153, 0.6);
  }

  #cam-page .empty-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: var(--muted);
    padding: 18px;
    white-space: nowrap;
  }
  #cam-page .empty-state .icon {
    width: 16px;
    height: 16px;
    opacity: 0.7;
  }

  #cam-page section.glass {
    padding: 24px 28px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  #cam-page section.glass h2 {
    margin-bottom: 4px;
  }
  #cam-page .cam-sections {
    display: flex;
    flex-direction: column;
    gap: 32px;
    align-items: stretch;
  }
  #cam-page .cam-sections section.glass {
    width: 100%;
  }
</style>
<div id="cam-page">
  <div class="content-container">
    <div class="cam-sections">
      <section class="glass">
        <div class="toolbar">
          <button class="btn" id="scan-button" onclick="scanCameras()">
            搜尋攝影機
          </button>
          <button class="btn btn-ghost" onclick="location.reload()">
            重新整理
          </button>
        </div>
        <h2>搜尋結果</h2>
        <div class="table-wrap">
          <table class="tbl">
            <colgroup>
              <col style="width: 64px" />
              <col style="width: 25%" />
              <col style="width: 30%" />
              <col />
              <col class="col-actions" style="width: 160px" />
            </colgroup>
            <thead>
              <tr>
                <th class="num">No.</th>
                <th>IP</th>
                <th>MAC</th>
                <th>名稱</th>
                <th class="col-actions">操作</th>
              </tr>
            </thead>
            <tbody id="search-results-body">
              {% if search_results %} {% for r in search_results %}
              <tr class="{% if r.is_bound %}is-bound{% endif %}">
                <td class="num">{{ forloop.counter }}</td>
                <td>
                  <span class="chip mono"
                    ><span class="dot" aria-hidden="true"></span>{{ r.ip}}</span
                  >
                </td>
                <td><span class="chip mono">{{ r.mac }}</span></td>
                <td>
                  {{ r.name }}{% if r.is_bound %}<span class="status-badge"
                    >已綁定</span
                  >{% endif %}
                </td>
                <td class="actions">
                  {% if r.is_bound %}
                  <button class="action-btn" disabled>
                    <svg
                      class="icon"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                    >
                      <path
                        d="m5 12 4 4 10-10"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                    已綁定
                  </button>
                  {% else %}
                  <button
                    class="action-btn"
                    onclick="addCam('{{ r.ip|escapejs }}','{{ r.mac|escapejs }}','{{ r.name|escapejs }}')"
                  >
                    <svg
                      class="icon"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                    >
                      <path
                        d="M12 5v14M5 12h14"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                    </svg>
                    添加
                  </button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="5" class="empty-state">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Z"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                    <path
                      d="M21 21l-4.35-4.35"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                  </svg>
                  請按「搜尋攝影機」進行搜尋。
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        {{ search_results|json_script:"initial-search-results" }}
        <div class="hint">提示：按下「搜尋攝影機」可更新列表。</div>
      </section>
      <section class="glass">
        <h2>已綁定攝影機</h2>
        <div class="table-wrap">
          <table class="tbl">
            <colgroup>
              <col style="width: 64px" />
              <col style="width: 25%" />
              <col style="width: 30%" />
              <col />
              <col class="col-actions" style="width: 160px" />
            </colgroup>
            <thead>
              <tr>
                <th class="num">No.</th>
                <th>IP</th>
                <th>MAC</th>
                <th>名稱</th>
                <th class="col-actions">操作</th>
              </tr>
            </thead>
            <tbody id="bound-list-body">
              {% if bound %} {% for cam in bound %}
              <tr>
                <td class="num">{{ forloop.counter }}</td>
                <td>
                  <span class="chip mono"
                    ><span class="dot" aria-hidden="true"></span>{{ cam.ip}}</span
                  >
                </td>
                <td><span class="chip mono">{{ cam.mac }}</span></td>
                <td>{{ cam.name }}</td>
                <td class="actions">
                  <button
                    class="action-btn danger"
                    onclick="delCam('{{ cam.mac|escapejs }}')"
                  >
                    <svg
                      class="icon"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                    >
                      <path
                        d="M3 6h18"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                      <path
                        d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                      <path
                        d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                    </svg>
                    刪除
                  </button>
                </td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="5" class="empty-state">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <circle
                      cx="12"
                      cy="12"
                      r="9"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                    <path
                      d="M8 12h8"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                  </svg>
                  尚未綁定任何攝影機
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
{{ bound|json_script:"initial-bound-list" }}
<script>
  (function () {
    function getCookie(name) {
      const v = document.cookie.match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)");
      return v ? v.pop() : "";
    }
    const CSRF = getCookie("csrftoken");

    const scanBtn = document.getElementById("scan-button");
    const searchTableBody = document.getElementById("search-results-body");
    const boundTableBody = document.getElementById("bound-list-body");
    const initialDataScript = document.getElementById("initial-search-results");
    const initialBoundScript = document.getElementById("initial-bound-list");

    let initialSearchRows = [];
    if (initialDataScript) {
      try {
        initialSearchRows = JSON.parse(initialDataScript.textContent) || [];
      } catch (err) {
        initialSearchRows = [];
      }
    }

    let initialBoundRows = [];
    if (initialBoundScript) {
      try {
        initialBoundRows = JSON.parse(initialBoundScript.textContent) || [];
      } catch (err) {
        initialBoundRows = [];
      }
    }

    let hasSearched = initialSearchRows.length > 0;
    let isScanning = false;

    const ICON_ADD =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
    const ICON_CHECK =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    const ICON_TRASH =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M3 6h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
    const ICON_STATUS_DEFAULT =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Z" stroke="currentColor" stroke-width="1.4" opacity=".6"/><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.4" opacity=".6"/></svg>';
    const ICON_STATUS_ERROR =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><circle cx="12" cy="16.5" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.4" opacity=".6"/></svg>';
    const ICON_STATUS_BOUND_EMPTY =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.4" opacity=".6"/><path d="M8 12h8" stroke="currentColor" stroke-width="1.4" opacity=".6"/></svg>';

    function createIconElement(svgMarkup) {
      const tpl = document.createElement("template");
      tpl.innerHTML = svgMarkup.trim();
      return tpl.content.firstElementChild;
    }

    function sanitizeIp(value) {
      return typeof value === "string" ? value.trim() : "";
    }

    function sanitizeMac(value) {
      return typeof value === "string"
        ? value.replace(/-/g, ":").trim().toUpperCase()
        : "";
    }

    function normalizeRow(row) {
      if (!row || typeof row !== "object") {
        return { ip: "", mac: "", name: "IPC", is_bound: Boolean(row && row.is_bound) };
      }
      const ip = sanitizeIp(row.ip);
      const mac = sanitizeMac(row.mac);
      const name =
        typeof row.name === "string" && row.name.trim()
          ? row.name.trim()
          : "IPC";
      return {
        ip,
        mac,
        name,
        is_bound: Boolean(row.is_bound),
      };
    }

    function compareIpValues(a, b) {
      const parse = (value) => {
        if (!value) return null;
        const parts = value.split(".");
        if (parts.length !== 4) return null;
        const nums = parts.map((part) => {
          const n = Number(part);
          return Number.isInteger(n) && n >= 0 && n <= 255 ? n : null;
        });
        return nums.some((n) => n === null) ? null : nums;
      };
      const pa = parse(a);
      const pb = parse(b);
      if (pa && pb) {
        for (let i = 0; i < pa.length; i += 1) {
          if (pa[i] !== pb[i]) {
            return pa[i] - pb[i];
          }
        }
        return 0;
      }
      if (pa && !pb) return -1;
      if (!pa && pb) return 1;
      return (a || "").localeCompare(b || "");
    }

    let searchRows = [];
    let boundRows = [];

    function sortSearchRows() {
      searchRows.sort((a, b) => {
        if (a.is_bound !== b.is_bound) {
          return a.is_bound ? 1 : -1;
        }
        const ipCmp = compareIpValues(a.ip, b.ip);
        if (ipCmp !== 0) return ipCmp;
        return (a.mac || "").localeCompare(b.mac || "");
      });
    }

    function sortBoundRows() {
      boundRows.sort((a, b) => {
        const ipCmp = compareIpValues(a.ip, b.ip);
        if (ipCmp !== 0) return ipCmp;
        return (a.mac || "").localeCompare(b.mac || "");
      });
    }

    function setSearchRows(rows) {
      if (Array.isArray(rows)) {
        searchRows = rows.map((row) => normalizeRow(row));
        sortSearchRows();
      } else {
        searchRows = [];
      }
    }

    function setBoundRows(rows) {
      if (Array.isArray(rows)) {
        boundRows = rows.map((row) => {
          const normalized = normalizeRow(row);
          normalized.is_bound = true;
          return normalized;
        });
        sortBoundRows();
      } else {
        boundRows = [];
      }
    }

    function upsertBoundRow(item) {
      const normalized = normalizeRow({ ...item, is_bound: true });
      if (!normalized.ip && !normalized.mac) {
        return;
      }
      let updated = false;
      boundRows = boundRows.map((row) => {
        if (
          (normalized.mac && row.mac === normalized.mac) ||
          (!normalized.mac && normalized.ip && row.ip === normalized.ip)
        ) {
          updated = true;
          return { ...normalized };
        }
        return row;
      });
      if (!updated) {
        boundRows.push({ ...normalized });
      }
      sortBoundRows();
      renderBoundRows();
    }

    function removeBoundRow(item) {
      const normalized = normalizeRow(item);
      const targetMac = normalized.mac;
      const targetIp = normalized.ip;
      boundRows = boundRows.filter((row) => {
        if (targetMac && row.mac === targetMac) return false;
        if (!targetMac && targetIp && row.ip === targetIp) return false;
        return true;
      });
      sortBoundRows();
      renderBoundRows();
    }

    function updateSearchBinding(item, isBound) {
      const normalized = normalizeRow(item);
      const targetMac = normalized.mac;
      const targetIp = normalized.ip;
      let found = false;
      searchRows = searchRows.map((row) => {
        const same =
          (targetMac && row.mac === targetMac) ||
          (!targetMac && targetIp && row.ip === targetIp);
        if (!same) return row;
        found = true;
        const next = { ...row, is_bound: isBound };
        if (isBound && normalized.name) {
          next.name = normalized.name;
        }
        return next;
      });
      if (!found && isBound) {
        const toAdd = { ...normalized, is_bound: true };
        searchRows.push(toAdd);
      }
      sortSearchRows();
      if (isBound) {
        hasSearched = true;
      }
      renderSearchRows();
    }

    function applyBoundState(item, fallback) {
      const merged = {
        ip: (item && item.ip) || (fallback && fallback.ip) || "",
        mac: (item && item.mac) || (fallback && fallback.mac) || "",
        name:
          (item && item.name) ||
          (fallback && fallback.name) ||
          (fallback && fallback.ipc_name) ||
          "",
        is_bound: true,
      };
      upsertBoundRow(merged);
      updateSearchBinding(merged, true);
    }

    function applyUnboundState(item, fallback) {
      const merged = {
        ip: (item && item.ip) || (fallback && fallback.ip) || "",
        mac: (item && item.mac) || (fallback && fallback.mac) || "",
        is_bound: false,
      };
      removeBoundRow(merged);
      updateSearchBinding(merged, false);
    }

    function buildStatusRow(message, { variant = "default" } = {}) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "empty-state";
      if (variant === "error") {
        td.dataset.error = "true";
      }
      const icon =
        variant === "error"
          ? createIconElement(ICON_STATUS_ERROR)
          : createIconElement(ICON_STATUS_DEFAULT);
      td.appendChild(icon);
      td.appendChild(document.createTextNode(" " + message));
      tr.appendChild(td);
      return tr;
    }

    function buildResultRow(row, index) {
      const tr = document.createElement("tr");
      if (row.is_bound) {
        tr.classList.add("is-bound");
      }

      const numTd = document.createElement("td");
      numTd.className = "num";
      numTd.textContent = String(index + 1);
      tr.appendChild(numTd);

      const ipTd = document.createElement("td");
      const ipChip = document.createElement("span");
      ipChip.className = "chip mono";
      const dot = document.createElement("span");
      dot.className = "dot";
      dot.setAttribute("aria-hidden", "true");
      ipChip.appendChild(dot);
      ipChip.appendChild(
        document.createTextNode(row.ip && row.ip.trim() ? row.ip : "—")
      );
      ipTd.appendChild(ipChip);
      tr.appendChild(ipTd);

      const macTd = document.createElement("td");
      const macChip = document.createElement("span");
      macChip.className = "chip mono";
      macChip.textContent = row.mac && row.mac.trim() ? row.mac : "—";
      macTd.appendChild(macChip);
      tr.appendChild(macTd);

      const nameTd = document.createElement("td");
      nameTd.appendChild(
        document.createTextNode(row.name && row.name.trim() ? row.name : "IPC")
      );
      if (row.is_bound) {
        const badge = document.createElement("span");
        badge.className = "status-badge";
        badge.textContent = "已綁定";
        nameTd.appendChild(badge);
      }
      tr.appendChild(nameTd);

      const actionTd = document.createElement("td");
      actionTd.className = "actions";
      if (row.is_bound) {
        const btn = document.createElement("button");
        btn.className = "action-btn";
        btn.disabled = true;
        btn.innerHTML = ICON_CHECK + "已綁定";
        actionTd.appendChild(btn);
      } else {
        const btn = document.createElement("button");
        btn.className = "action-btn";
        btn.type = "button";
        btn.innerHTML = ICON_ADD + "添加";
        btn.addEventListener("click", () =>
          addCam(row.ip || "", row.mac || "", row.name || "")
        );
        actionTd.appendChild(btn);
      }
      tr.appendChild(actionTd);

      return tr;
    }

    function buildBoundEmptyRow() {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "empty-state";
      td.appendChild(createIconElement(ICON_STATUS_BOUND_EMPTY));
      td.appendChild(document.createTextNode(" 尚未綁定任何攝影機"));
      tr.appendChild(td);
      return tr;
    }

    function buildBoundRow(row, index) {
      const tr = document.createElement("tr");

      const numTd = document.createElement("td");
      numTd.className = "num";
      numTd.textContent = String(index + 1);
      tr.appendChild(numTd);

      const ipTd = document.createElement("td");
      const ipChip = document.createElement("span");
      ipChip.className = "chip mono";
      const dot = document.createElement("span");
      dot.className = "dot";
      dot.setAttribute("aria-hidden", "true");
      ipChip.appendChild(dot);
      ipChip.appendChild(
        document.createTextNode(row.ip && row.ip.trim() ? row.ip : "—")
      );
      ipTd.appendChild(ipChip);
      tr.appendChild(ipTd);

      const macTd = document.createElement("td");
      const macChip = document.createElement("span");
      macChip.className = "chip mono";
      macChip.textContent = row.mac && row.mac.trim() ? row.mac : "—";
      macTd.appendChild(macChip);
      tr.appendChild(macTd);

      const nameTd = document.createElement("td");
      nameTd.textContent = row.name && row.name.trim() ? row.name : "IPC";
      tr.appendChild(nameTd);

      const actionTd = document.createElement("td");
      actionTd.className = "actions";
      const btn = document.createElement("button");
      btn.className = "action-btn danger";
      btn.type = "button";
      btn.innerHTML = ICON_TRASH + "刪除";
      btn.addEventListener("click", () =>
        delCam(row.mac || "", row.ip || "")
      );
      actionTd.appendChild(btn);
      tr.appendChild(actionTd);

      return tr;
    }

    function renderSearchRows(rows, state = {}) {
      if (!searchTableBody) return;
      const { loading = false, error = "" } = state;
      if (!loading && !error && Array.isArray(rows)) {
        setSearchRows(rows);
        if (rows.length) {
          hasSearched = true;
        }
      }
      searchTableBody.innerHTML = "";
      if (loading) {
        searchTableBody.appendChild(
          buildStatusRow("掃描中，請稍候…", { variant: "loading" })
        );
        return;
      }
      if (error) {
        searchTableBody.appendChild(
          buildStatusRow(error, { variant: "error" })
        );
        return;
      }
      sortSearchRows();
      if (!searchRows.length) {
        const message = hasSearched
          ? "未找到任何裝置"
          : "請按「搜尋攝影機」進行搜尋";
        searchTableBody.appendChild(buildStatusRow(message));
        return;
      }
      searchRows.forEach((row, index) => {
        searchTableBody.appendChild(buildResultRow(row, index));
      });
    }

    function renderBoundRows(rows) {
      if (!boundTableBody) return;
      if (Array.isArray(rows)) {
        setBoundRows(rows);
      }
      boundTableBody.innerHTML = "";
      if (!boundRows.length) {
        boundTableBody.appendChild(buildBoundEmptyRow());
        return;
      }
      sortBoundRows();
      boundRows.forEach((row, index) => {
        boundTableBody.appendChild(buildBoundRow(row, index));
      });
    }

    setSearchRows(initialSearchRows);
    setBoundRows(initialBoundRows);
    hasSearched = hasSearched || searchRows.length > 0;
    renderSearchRows();
    renderBoundRows();

    if (typeof window.refreshSearch !== "function") {
      window.refreshSearch = function () {
        location.reload();
      };
    }

    if (typeof window.addCam !== "function") {
      window.addCam = async function (ip, mac, name) {
        const ipClean = sanitizeIp(ip);
        const macClean = sanitizeMac(mac);
        const nameClean = typeof name === "string" ? name.trim() : "";
        const fallbackItem = {
          ip: ipClean,
          mac: macClean,
          name: nameClean || "IPC",
          is_bound: true,
          ipc_name: nameClean,
        };
        const payload = {
          ip_address: ipClean,
          mac_address: macClean,
          ipc_name: nameClean,
        };
        try {
          const res = await fetch("{% url 'api_cameras_bind' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": CSRF,
            },
            body: JSON.stringify(payload),
          });
          const j = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(j.error || "HTTP " + res.status);
          if (j.ok) {
            applyBoundState(j.item, fallbackItem);
          } else if (j.code === "ALREADY_BOUND") {
            applyBoundState(j.item, fallbackItem);
            alert("這台攝影機已經綁定在列表中。");
          } else {
            alert("新增失敗：" + (j.error || JSON.stringify(j)));
          }
        } catch (err) {
          alert("請求失敗：" + err.message);
        }
      };
    }

    window.scanCameras = async function () {
      if (isScanning) return;
      isScanning = true;
      hasSearched = true;
      renderSearchRows([], { loading: true });
      if (scanBtn) {
        scanBtn.disabled = true;
      }
      try {
        const res = await fetch("{% url 'api_cameras_scan' %}", {
          method: "GET",
          headers: {
            Accept: "application/json",
          },
          credentials: "same-origin",
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        if (!data.ok) {
          throw new Error(data.error || "掃描失敗");
        }
        const rows = Array.isArray(data.results) ? data.results : [];
        renderSearchRows(rows);
      } catch (err) {
        renderSearchRows([], { error: "掃描失敗：" + err.message });
      } finally {
        isScanning = false;
        if (scanBtn) {
          scanBtn.disabled = false;
        }
      }
    };

    if (typeof window.delCam !== "function") {
      window.delCam = async function (mac, ip = "") {
        if (!confirm("確定要刪除這台攝影機嗎？")) return;
        const macClean = sanitizeMac(mac);
        const ipClean = sanitizeIp(ip);
        const payload = {};
        if (macClean) {
          payload.mac_address = macClean;
        }
        if (ipClean && !payload.mac_address) {
          payload.ip_address = ipClean;
        }
        const fallbackItem = {
          ip: ipClean,
          mac: macClean,
        };
        try {
          const res = await fetch("{% url 'api_cameras_unbind' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": CSRF,
            },
            body: JSON.stringify(payload),
          });
          const j = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(j.error || "HTTP " + res.status);
          if (j.ok) {
            applyUnboundState(j.item, fallbackItem);
          } else {
            alert("刪除失敗：" + (j.error || JSON.stringify(j)));
          }
        } catch (err) {
          alert("請求失敗：" + err.message);
        }
      };
    }
  })();
</script>
{% endblock %}
