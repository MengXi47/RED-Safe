{% extends "ui/base.html" %}
{% block title %}攝影機管理{% endblock %}
{% block header %}攝影機管理{% endblock %} {% block content %}
<style>
  /* ===== Cameras page scoped styles ===== */
  #cam-page .tbl {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 720px;
  }
  #cam-page .tbl th,
  #cam-page .tbl td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--line);
    text-align: left;
  }
  #cam-page .tbl th,
  #cam-page .tbl td {
    vertical-align: middle;
  }
  #cam-page .tbl td .chip,
  #cam-page .tbl td button.action-btn {
    display: inline-flex;
    align-items: center;
  }
  #cam-page .tbl th {
    height: 48px;
    line-height: 48px;
  }
  #cam-page .tbl td {
    height: 48px;
    line-height: 1.4;
  }
  #cam-page .tbl thead th {
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    font-size: 12px;
    text-transform: uppercase;
    /* keep headers on one line and avoid CJK splitting */
    white-space: nowrap;
    word-break: keep-all;
    /* reduce spacing to avoid unintended wraps */
    letter-spacing: 0.02em;
  }
  @media (prefers-color-scheme: dark) {
    #cam-page .tbl thead th {
      background: rgba(17, 24, 39, 0.55);
    }
  }

#cam-page .tbl thead th,
#cam-page .tbl thead th * {
  overflow-wrap: normal;
}
  #cam-page .tbl tbody tr:hover {
    background: rgba(255, 255, 255, 0.06);
  }
  #cam-page .tbl tbody tr.is-bound {
    opacity: 0.8;
  }
  #cam-page .tbl tbody tr.is-bound:hover {
    background: rgba(96, 165, 250, 0.08);
  }

  #cam-page .num {
    width: 64px;
    text-align: center;
  }
  #cam-page .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border: 1px solid var(--line);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.45);
  }
  @media (prefers-color-scheme: dark) {
    #cam-page .chip {
      background: rgba(255, 255, 255, 0.06);
    }
  }
  #cam-page .chip .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #60a5fa;
    box-shadow: 0 0 8px rgba(96, 165, 250, 0.6);
  }
  #cam-page .chip.mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", monospace;
  }

  #cam-page .actions {
    white-space: nowrap;
    display: flex;
    gap: 8px;
  }
  #cam-page .col-actions {
    width: 220px;
  }
  #cam-page .tbl .actions {
    justify-content: flex-start;
  }
  #cam-page .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: transparent;
    cursor: pointer;
  }
  #cam-page .action-btn:hover {
    background: rgba(255, 255, 255, 0.08);
  }
  #cam-page .action-btn[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
    background: transparent;
  }
  #cam-page .action-btn.danger {
    border-color: transparent;
    background: linear-gradient(
      180deg,
      var(--danger),
      calc(100% - 1px),
      #e34b50
    );
    color: #fff;
  }
  #cam-page .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    letter-spacing: 0.02em;
    background: rgba(96, 165, 250, 0.16);
    color: #1d4ed8;
    margin-left: 8px;
  }
  #cam-page .tbl tbody tr.is-bound .status-badge {
    background: rgba(52, 211, 153, 0.18);
    color: #047857;
  }
  #cam-page .tbl tbody tr.is-bound .chip .dot {
    background: #34d399;
    box-shadow: 0 0 6px rgba(52, 211, 153, 0.6);
  }

  #cam-page .empty-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: var(--muted);
    padding: 18px;
    white-space: nowrap;
  }
  #cam-page .empty-state .icon {
    width: 16px;
    height: 16px;
    opacity: 0.7;
  }

  #cam-page section.glass {
    padding: 24px 28px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  #cam-page section.glass h2 {
    margin-bottom: 4px;
  }
  #cam-page .cam-sections {
    display: flex;
    flex-direction: column;
    gap: 32px;
    align-items: stretch;
  }
  #cam-page .cam-sections section.glass {
    width: 100%;
  }
  #cam-modal-backdrop,
  #cam-preview-backdrop,
  #cam-preview-auth-backdrop {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: rgba(15, 23, 42, 0.45);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 200;
  }
  #cam-modal-backdrop.is-active,
  #cam-preview-backdrop.is-active,
  #cam-preview-auth-backdrop.is-active {
    display: flex;
  }
  .cam-modal {
    width: 100%;
    max-width: 420px;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 18px 36px rgba(30, 41, 59, 0.18);
    padding: 24px;
  }
  @media (prefers-color-scheme: dark) {
    .cam-modal {
      background: #111827;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
    }
  }
  .cam-preview-modal {
    max-width: 760px;
  }
  .cam-preview-header {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 16px;
  }
  .cam-preview-meta {
    font-size: 13px;
    color: rgba(55, 65, 81, 0.75);
    word-break: break-all;
  }
  @media (prefers-color-scheme: dark) {
    .cam-preview-meta {
      color: rgba(226, 232, 240, 0.7);
    }
  }
  .cam-preview-body {
    display: flex;
    justify-content: center;
    margin-bottom: 16px;
  }
  .cam-preview-stage {
    position: relative;
    width: min(100%, 640px);
    aspect-ratio: 4 / 3;
    background: #0f172a;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .cam-preview-stage video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #000;
    display: block;
  }
  .cam-preview-loading,
  .cam-preview-error {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 24px;
    text-align: center;
  }
  .cam-preview-loading {
    color: #f8fafc;
    background: rgba(15, 23, 42, 0.55);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
  }
  .cam-preview-loading .spinner {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 3px solid rgba(148, 163, 184, 0.35);
    border-top-color: #60a5fa;
    animation: cam-spin 1s linear infinite;
  }
  .cam-preview-error {
    color: #fee2e2;
    background: rgba(220, 38, 38, 0.78);
  }
  .cam-preview-auth-desc {
    font-size: 14px;
    color: rgba(55, 65, 81, 0.8);
    margin: -4px 0 12px;
  }
  @media (prefers-color-scheme: dark) {
    .cam-preview-auth-desc {
      color: rgba(226, 232, 240, 0.75);
    }
  }
  @keyframes cam-spin {
    to {
      transform: rotate(360deg);
    }
  }
  .cam-modal h3 {
    margin: 0 0 16px;
    font-size: 20px;
    font-weight: 600;
  }
  .cam-modal .cam-modal-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
    font-size: 13px;
  }
  .cam-modal .cam-modal-meta .meta-box {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .cam-modal .cam-modal-meta .meta-label {
    font-size: 12px;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    color: rgba(55, 65, 81, 0.85);
  }
  .cam-modal .cam-modal-meta .meta-value {
    display: block;
    padding: 8px 10px;
    border-radius: 10px;
    background: rgba(148, 163, 184, 0.14);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", monospace;
    word-break: break-all;
  }
  @media (prefers-color-scheme: dark) {
    .cam-modal .cam-modal-meta .meta-label {
      color: rgba(226, 232, 240, 0.8);
    }
    .cam-modal .cam-modal-meta .meta-value {
      background: rgba(255, 255, 255, 0.08);
      color: #f9fafb;
    }
  }
  .cam-modal label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .cam-modal input[type="text"],
  .cam-modal input[type="password"] {
    width: 100%;
    border-radius: 10px;
    border: 1px solid var(--line, #d1d5db);
    padding: 10px 12px;
    background: rgba(255, 255, 255, 0.9);
    font-size: 14px;
  }
  @media (prefers-color-scheme: dark) {
    .cam-modal input[type="text"],
    .cam-modal input[type="password"] {
      background: rgba(17, 24, 39, 0.85);
      border-color: rgba(148, 163, 184, 0.35);
      color: #f9fafb;
    }
  }
  .cam-modal .field {
    margin-bottom: 14px;
  }
  .cam-modal .actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
  }
  .cam-modal .actions button {
    min-width: 92px;
    padding: 8px 14px;
    border-radius: 10px;
    border: 1px solid var(--line, #d1d5db);
    background: rgba(255, 255, 255, 0.85);
    cursor: pointer;
  }
  .cam-modal .actions button.primary {
    background: linear-gradient(180deg, #3b82f6, #2563eb);
    color: #fff;
    border-color: transparent;
  }
  .cam-modal .actions button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .cam-modal .error-message {
    margin-top: 8px;
    font-size: 13px;
    color: #dc2626;
  }
</style>
<div id="cam-page">
  <div
    id="cam-modal-backdrop"
    aria-hidden="true"
  >
    <div class="cam-modal" role="dialog" aria-modal="true" aria-labelledby="cam-modal-title">
      <h3 id="cam-modal-title">綁定攝影機</h3>
      <form id="cam-modal-form" autocomplete="off">
        <input type="hidden" id="cam-modal-ip" name="ip_address" />
        <input type="hidden" id="cam-modal-mac" name="mac_address" />
        <input type="hidden" id="cam-modal-ipc-name" name="ipc_name" />
        <div class="cam-modal-meta">
          <div class="meta-box">
            <div class="meta-label">IP 位址</div>
            <div class="meta-value" id="cam-modal-ip-display"></div>
          </div>
          <div class="meta-box">
            <div class="meta-label">MAC 位址</div>
            <div class="meta-value" id="cam-modal-mac-display"></div>
          </div>
        </div>
        <div class="field">
          <label for="cam-modal-custom-name">攝影機名稱</label>
          <input
            id="cam-modal-custom-name"
            type="text"
            name="custom_name"
            placeholder="請輸入顯示名稱"
            maxlength="255"
          />
        </div>
        <div class="field">
          <label for="cam-modal-account">攝影機帳號</label>
          <input
            id="cam-modal-account"
            type="text"
            name="ipc_account"
            placeholder="選填：攝影機登入帳號"
            autocomplete="username"
            maxlength="255"
          />
        </div>
        <div class="field">
          <label for="cam-modal-password">攝影機密碼</label>
          <input
            id="cam-modal-password"
            type="password"
            name="ipc_password"
            placeholder="選填：攝影機登入密碼"
            autocomplete="current-password"
            maxlength="255"
          />
        </div>
        <div class="error-message" id="cam-modal-error" hidden></div>
        <div class="actions">
          <button type="button" id="cam-modal-cancel">取消</button>
          <button type="submit" class="primary" id="cam-modal-submit">確定新增</button>
        </div>
      </form>
    </div>
  </div>
  <div
    id="cam-preview-backdrop"
    aria-hidden="true"
  >
    <div
      class="cam-modal cam-preview-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="cam-preview-title"
    >
      <div class="cam-preview-header">
        <h3 id="cam-preview-title">攝影機預覽</h3>
        <div class="cam-preview-meta" id="cam-preview-meta"></div>
      </div>
      <div class="cam-preview-body">
        <div class="cam-preview-stage">
          <div class="cam-preview-loading" id="cam-preview-loading">
            <span class="spinner" aria-hidden="true"></span>
            <span>正在建立預覽…</span>
          </div>
          <div class="cam-preview-error" id="cam-preview-inline-error" hidden>
            無法連接攝影機
          </div>
          <video
            id="cam-preview-video"
            autoplay
            muted
            playsinline
            preload="auto"
          ></video>
        </div>
      </div>
      <div class="actions">
        <button type="button" id="cam-preview-close">關閉</button>
      </div>
    </div>
  </div>
  <div
    id="cam-preview-auth-backdrop"
    aria-hidden="true"
  >
    <div
      class="cam-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="cam-preview-auth-title"
    >
      <h3 id="cam-preview-auth-title">需要攝影機帳號密碼</h3>
      <p class="cam-preview-auth-desc">
        無法直接預覽此攝影機，請輸入登入帳號與密碼後再試一次。
      </p>
      <form id="cam-preview-auth-form" autocomplete="off">
        <div class="field">
          <label for="cam-preview-auth-account">帳號</label>
          <input
            id="cam-preview-auth-account"
            type="text"
            name="account"
            autocomplete="username"
            maxlength="255"
          />
        </div>
        <div class="field">
          <label for="cam-preview-auth-password">密碼</label>
          <input
            id="cam-preview-auth-password"
            type="password"
            name="password"
            autocomplete="current-password"
            maxlength="255"
          />
        </div>
        <div class="error-message" id="cam-preview-auth-error" hidden></div>
        <div class="actions">
          <button type="button" id="cam-preview-auth-cancel">取消</button>
          <button type="submit" class="primary" id="cam-preview-auth-submit">
            重新嘗試
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="content-container">
    <div class="cam-sections">
      <section class="glass">
        <div class="toolbar">
          <button class="btn" id="scan-button" onclick="scanCameras()">
            搜尋攝影機
          </button>
          <button class="btn btn-ghost" onclick="location.reload()">
            重新整理
          </button>
        </div>
        <h2>搜尋結果</h2>
        <div class="table-wrap">
          <table class="tbl">
            <colgroup>
              <col style="width: 64px" />
              <col style="width: 25%" />
              <col style="width: 30%" />
              <col />
              <col class="col-actions" style="width: 220px" />
            </colgroup>
            <thead>
              <tr>
                <th class="num">No.</th>
                <th>IP</th>
                <th>MAC</th>
                <th>名稱</th>
                <th class="col-actions">操作</th>
              </tr>
            </thead>
            <tbody id="search-results-body">
              {% if search_results %} {% for r in search_results %}
              <tr class="{% if r.is_bound %}is-bound{% endif %}">
                <td class="num">{{ forloop.counter }}</td>
                <td>
                  <span class="chip mono"
                    ><span class="dot" aria-hidden="true"></span>{{ r.ip}}</span
                  >
                </td>
                <td><span class="chip mono">{{ r.mac }}</span></td>
                <td>
                  {{ r.name }}{% if r.is_bound %}<span class="status-badge"
                    >已綁定</span
                  >{% endif %}
                </td>
                <td class="actions">
                  <button
                    class="action-btn"
                    type="button"
                    onclick="previewCam('{{ r.ip|escapejs }}','{{ r.mac|escapejs }}','{{ r.name|escapejs }}')"
                  >
                    <svg
                      class="icon"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                    >
                      <path
                        d="M12 6c5.25 0 9.75 6 9.75 6s-4.5 6-9.75 6S2.25 12 2.25 12s4.5-6 9.75-6Z"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <circle
                        cx="12"
                        cy="12"
                        r="2.6"
                        stroke="currentColor"
                        stroke-width="1.6"
                      />
                    </svg>
                    預覽
                  </button>
                  {% if r.is_bound %}
                  <button class="action-btn" disabled>
                    <svg
                      class="icon"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                    >
                      <path
                        d="m5 12 4 4 10-10"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                    已綁定
                  </button>
                  {% else %}
                  <button
                    class="action-btn"
                    onclick="addCam('{{ r.ip|escapejs }}','{{ r.mac|escapejs }}','{{ r.name|escapejs }}')"
                  >
                    <svg
                      class="icon"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                    >
                      <path
                        d="M12 5v14M5 12h14"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                    </svg>
                    添加
                  </button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="5" class="empty-state">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Z"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                    <path
                      d="M21 21l-4.35-4.35"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                  </svg>
                  請按「搜尋攝影機」進行搜尋。
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        {{ search_results|json_script:"initial-search-results" }}
        <div class="hint">提示：按下「搜尋攝影機」可更新列表。</div>
      </section>
      <section class="glass">
        <h2>已綁定攝影機</h2>
        <div class="table-wrap">
          <table class="tbl">
            <colgroup>
              <col style="width: 64px" />
              <col style="width: 25%" />
              <col style="width: 30%" />
              <col />
              <col class="col-actions" style="width: 220px" />
            </colgroup>
            <thead>
              <tr>
                <th class="num">No.</th>
                <th>IP</th>
                <th>MAC</th>
                <th>名稱</th>
                <th class="col-actions">操作</th>
              </tr>
            </thead>
            <tbody id="bound-list-body">
              {% if bound %} {% for cam in bound %}
              <tr>
                <td class="num">{{ forloop.counter }}</td>
                <td>
                  <span class="chip mono"
                    ><span class="dot" aria-hidden="true"></span>{{ cam.ip}}</span
                  >
                </td>
                <td><span class="chip mono">{{ cam.mac }}</span></td>
                <td>{{ cam.name }}</td>
                <td class="actions">
                  <button
                    class="action-btn danger"
                    onclick="delCam('{{ cam.mac|escapejs }}')"
                  >
                    <svg
                      class="icon"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                    >
                      <path
                        d="M3 6h18"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                      <path
                        d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                      <path
                        d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                      />
                    </svg>
                    刪除
                  </button>
                </td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="5" class="empty-state">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <circle
                      cx="12"
                      cy="12"
                      r="9"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                    <path
                      d="M8 12h8"
                      stroke="currentColor"
                      stroke-width="1.4"
                      opacity=".6"
                    />
                  </svg>
                  尚未綁定任何攝影機
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
{{ bound|json_script:"initial-bound-list" }}
<script>
  (function () {
    function getCookie(name) {
      const v = document.cookie.match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)");
      return v ? v.pop() : "";
    }
    const CSRF = getCookie("csrftoken");

    const scanBtn = document.getElementById("scan-button");
    const searchTableBody = document.getElementById("search-results-body");
    const boundTableBody = document.getElementById("bound-list-body");
    const initialDataScript = document.getElementById("initial-search-results");
    const initialBoundScript = document.getElementById("initial-bound-list");
    const camModalBackdrop = document.getElementById("cam-modal-backdrop");
    const camModalForm = document.getElementById("cam-modal-form");
    const camModalIpInput = document.getElementById("cam-modal-ip");
    const camModalMacInput = document.getElementById("cam-modal-mac");
    const camModalIpcNameInput = document.getElementById("cam-modal-ipc-name");
    const camModalCustomNameInput = document.getElementById("cam-modal-custom-name");
    const camModalAccountInput = document.getElementById("cam-modal-account");
    const camModalPasswordInput = document.getElementById("cam-modal-password");
    const camModalErrorBox = document.getElementById("cam-modal-error");
    const camModalCancelBtn = document.getElementById("cam-modal-cancel");
    const camModalSubmitBtn = document.getElementById("cam-modal-submit");
    const camModalIpDisplay = document.getElementById("cam-modal-ip-display");
    const camModalMacDisplay = document.getElementById("cam-modal-mac-display");
    const camModalSubmitDefault =
      camModalSubmitBtn ? camModalSubmitBtn.textContent : "確定新增";
    const camModalSubmitProcessingText = "處理中…";
    const previewBackdrop = document.getElementById("cam-preview-backdrop");
    const previewTitle = document.getElementById("cam-preview-title");
    const previewMeta = document.getElementById("cam-preview-meta");
    const previewVideoEl = document.getElementById("cam-preview-video");
    const previewLoadingBox = document.getElementById("cam-preview-loading");
    const previewInlineError = document.getElementById("cam-preview-inline-error");
    const previewCloseBtn = document.getElementById("cam-preview-close");
    const previewAuthBackdrop = document.getElementById("cam-preview-auth-backdrop");
    const previewAuthForm = document.getElementById("cam-preview-auth-form");
    const previewAuthAccountInput = document.getElementById("cam-preview-auth-account");
    const previewAuthPasswordInput = document.getElementById("cam-preview-auth-password");
    const previewAuthErrorBox = document.getElementById("cam-preview-auth-error");
    const previewAuthCancelBtn = document.getElementById("cam-preview-auth-cancel");
    const previewAuthSubmitBtn = document.getElementById("cam-preview-auth-submit");
    const previewAuthSubmitDefault =
      previewAuthSubmitBtn ? previewAuthSubmitBtn.textContent : "重新嘗試";
    const previewAuthSubmitLoadingText = "重新嘗試中…";
    const PREVIEW_PROBE_URL = "{% url 'api_cameras_preview_probe' %}";
    const PREVIEW_WEBRTC_OFFER_URL = "{% url 'api_cameras_preview_webrtc_offer' %}";
    const PREVIEW_WEBRTC_HANGUP_URL = "{% url 'api_cameras_preview_webrtc_hangup' %}";

    let initialSearchRows = [];
    if (initialDataScript) {
      try {
        initialSearchRows = JSON.parse(initialDataScript.textContent) || [];
      } catch (err) {
        initialSearchRows = [];
      }
    }

    let initialBoundRows = [];
    if (initialBoundScript) {
      try {
        initialBoundRows = JSON.parse(initialBoundScript.textContent) || [];
      } catch (err) {
        initialBoundRows = [];
      }
    }

    let hasSearched = initialSearchRows.length > 0;
    let isScanning = false;

    let camModalSubmitting = false;
    let camModalState = { deviceName: "" };
    const previewState = {
      ip: "",
      mac: "",
      name: "",
      account: "",
      password: "",
      streamUrl: "",
      streamActive: false,
      firstFrameLoaded: false,
      dismissedByUser: false,
      peerConnection: null,
      sessionId: "",
    };
    let previewAuthSubmitting = false;

    function stopPreviewStream(options = {}) {
      const { notifyServer = true } = options;
      const currentPc = previewState.peerConnection;
      const sessionId = previewState.sessionId;
      previewState.streamActive = false;
      previewState.streamUrl = "";
      previewState.firstFrameLoaded = false;
      previewState.peerConnection = null;
      previewState.sessionId = "";

      if (currentPc) {
        try {
          currentPc.oniceconnectionstatechange = null;
          currentPc.onconnectionstatechange = null;
          currentPc.ontrack = null;
        } catch (err) {
          // ignore cleanup errors
        }
        try {
          currentPc.getSenders().forEach((sender) => {
            if (sender.track) {
              sender.track.stop();
            }
          });
        } catch (err) {
          // ignore sender cleanup errors
        }
        try {
          currentPc.getReceivers().forEach((receiver) => {
            if (receiver.track) {
              receiver.track.stop();
            }
          });
        } catch (err) {
          // ignore receiver cleanup errors
        }
        try {
          currentPc.close();
        } catch (err) {
          // ignore close errors
        }
      }

      if (notifyServer && sessionId) {
        fetch(PREVIEW_WEBRTC_HANGUP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF,
          },
          body: JSON.stringify({ session_id: sessionId }),
        }).catch(() => {
          /* swallow network errors */
        });
      }

      if (previewVideoEl) {
        try {
          previewVideoEl.pause();
        } catch (err) {
          // ignore pause errors when element is detached
        }
        previewVideoEl.srcObject = null;
        previewVideoEl.removeAttribute("src");
        previewVideoEl.load();
      }
      showPreviewLoading();
    }

    function closePreviewModal({ dismissedByUser = false } = {}) {
      stopPreviewStream();
      if (dismissedByUser) {
        previewState.dismissedByUser = true;
      }
      if (previewBackdrop) {
        previewBackdrop.classList.remove("is-active");
        previewBackdrop.setAttribute("aria-hidden", "true");
      }
    }

    function setPreviewInlineError(message = "") {
      if (!previewInlineError) {
        return;
      }
      if (message) {
        previewInlineError.textContent = message;
        previewInlineError.hidden = false;
        previewInlineError.style.display = "flex";
      } else {
        previewInlineError.textContent = "";
        previewInlineError.hidden = true;
        previewInlineError.style.display = "none";
      }
    }

    function openPreviewModal() {
      if (!previewBackdrop) {
        alert("目前無法顯示預覽視窗。");
        return;
      }
      stopPreviewStream();
      previewState.dismissedByUser = false;
      if (previewTitle) {
        previewTitle.textContent = previewState.name || "攝影機預覽";
      }
      if (previewMeta) {
        previewMeta.textContent = previewState.ip || "";
      }
      showPreviewLoading();
      setPreviewInlineError();
      previewBackdrop.classList.add("is-active");
      previewBackdrop.setAttribute("aria-hidden", "false");
    }

    function markPreviewReady() {
      if (!previewState.streamActive || previewState.firstFrameLoaded) {
        return;
      }
      previewState.firstFrameLoaded = true;
      hidePreviewLoading();
      setPreviewInlineError();
    }

    function showPreviewLoading() {
      if (!previewLoadingBox) {
        return;
      }
      previewLoadingBox.hidden = false;
      previewLoadingBox.classList.remove("is-hidden");
      previewLoadingBox.style.display = "";
    }

    function hidePreviewLoading() {
      if (!previewLoadingBox) {
        return;
      }
      previewLoadingBox.hidden = true;
      previewLoadingBox.classList.add("is-hidden");
      previewLoadingBox.style.display = "none";
    }

    function waitForIceGathering(pc, timeoutMs = 3000) {
      if (pc.iceGatheringState === "complete") {
        return Promise.resolve();
      }
      return new Promise((resolve) => {
        const timer = setTimeout(() => {
          pc.removeEventListener("icegatheringstatechange", checkState);
          resolve();
        }, timeoutMs);

        function checkState() {
          if (pc.iceGatheringState === "complete") {
            clearTimeout(timer);
            pc.removeEventListener("icegatheringstatechange", checkState);
            resolve();
          }
        }

        pc.addEventListener("icegatheringstatechange", checkState);
      });
    }

    async function startPreviewWebRTC() {
      if (!previewVideoEl || !previewState.ip) {
        return;
      }

      if (typeof RTCPeerConnection === "undefined") {
        setPreviewInlineError("此瀏覽器不支援 WebRTC 預覽");
        hidePreviewLoading();
        return;
      }

      stopPreviewStream({ notifyServer: false });

      previewState.streamActive = true;
      previewState.firstFrameLoaded = false;
      previewState.dismissedByUser = false;
      setPreviewInlineError();
      showPreviewLoading();

      const pc = new RTCPeerConnection({
        iceServers: [
          {
            urls: ["stun:stun.l.google.com:19302", "stun:stun1.l.google.com:19302"],
          },
        ],
      });

      previewState.peerConnection = pc;

      try {
        if (typeof pc.addTransceiver === "function") {
          pc.addTransceiver("video", { direction: "recvonly" });
        }
      } catch (err) {
        // ignore transceiver errors on older browsers
      }

      pc.addEventListener("track", (event) => {
        if (!event.streams || !event.streams[0]) {
          return;
        }
        if (previewVideoEl.srcObject !== event.streams[0]) {
          previewVideoEl.srcObject = event.streams[0];
        }
        try {
          const playPromise = previewVideoEl.play();
          if (playPromise && typeof playPromise.catch === "function") {
            playPromise.catch(() => {
              /* allow muted autoplay fallback */
            });
          }
        } catch (err) {
          // ignore autoplay errors
        }
        markPreviewReady();
      });

      const handleConnectionChange = () => {
        if (!previewState.streamActive) {
          return;
        }
        const state = pc.iceConnectionState || pc.connectionState;
        if (state === "connected") {
          if (!previewState.firstFrameLoaded) {
            showPreviewLoading();
          }
        } else if (state === "failed") {
          stopPreviewStream({ notifyServer: true });
          setPreviewInlineError("預覽連線失敗");
        } else if (state === "disconnected") {
          setPreviewInlineError("預覽連線中斷");
          hidePreviewLoading();
        }
      };

      pc.addEventListener("iceconnectionstatechange", handleConnectionChange);
      pc.addEventListener("connectionstatechange", handleConnectionChange);

      try {
        const offer = await pc.createOffer({ offerToReceiveVideo: true });
        await pc.setLocalDescription(offer);
        await waitForIceGathering(pc);

        const payload = {
          ip: previewState.ip,
          account: previewState.account,
          password: previewState.password,
          offer: {
            type: pc.localDescription?.type,
            sdp: pc.localDescription?.sdp,
          },
        };

        const res = await fetch(PREVIEW_WEBRTC_OFFER_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF,
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok || !data.answer) {
          throw new Error(data.error || "無法連接攝影機");
        }

        previewState.sessionId = data.session_id || "";

        const answerInit = {
          type: data.answer.type,
          sdp: data.answer.sdp,
        };
        const answerDesc =
          typeof RTCSessionDescription === "function"
            ? new RTCSessionDescription(answerInit)
            : answerInit;
        await pc.setRemoteDescription(answerDesc);

        if (previewState.firstFrameLoaded) {
          hidePreviewLoading();
        }
      } catch (err) {
        stopPreviewStream({ notifyServer: true });
        const message = err && err.message ? err.message : "無法連接攝影機";
        if (previewBackdrop?.classList.contains("is-active") && !previewState.dismissedByUser) {
          setPreviewInlineError(message);
        }
        if (!previewState.dismissedByUser) {
          console.warn("WebRTC preview failed:", err);
        }
      }
    }

    function resetPreviewAuthError(message = "") {
      if (!previewAuthErrorBox) {
        return;
      }
      if (message) {
        previewAuthErrorBox.textContent = message;
        previewAuthErrorBox.hidden = false;
      } else {
        previewAuthErrorBox.textContent = "";
        previewAuthErrorBox.hidden = true;
      }
    }

    function setPreviewAuthLoading(isLoading) {
      previewAuthSubmitting = isLoading;
      if (previewAuthSubmitBtn) {
        previewAuthSubmitBtn.disabled = isLoading;
        previewAuthSubmitBtn.textContent = isLoading
          ? previewAuthSubmitLoadingText
          : previewAuthSubmitDefault;
      }
      if (previewAuthAccountInput) {
        previewAuthAccountInput.disabled = isLoading;
      }
      if (previewAuthPasswordInput) {
        previewAuthPasswordInput.disabled = isLoading;
      }
    }

    function closePreviewAuthModal() {
      if (!previewAuthBackdrop) {
        return;
      }
      previewAuthBackdrop.classList.remove("is-active");
      previewAuthBackdrop.setAttribute("aria-hidden", "true");
      setPreviewAuthLoading(false);
      resetPreviewAuthError();
    }

    function openPreviewAuthModal(options = {}) {
      const { message = "", focusPassword = false } = options;
      if (!previewAuthBackdrop) {
        const accountInput =
          window.prompt("請輸入攝影機帳號", previewState.account || "") || "";
        const passwordInput =
          window.prompt("請輸入攝影機密碼", previewState.password || "") || "";
        attemptPreviewWithCredentials(
          {
            account: (accountInput || "").trim(),
            password: passwordInput || "",
          },
          { promptOnAuthFailure: false }
        );
        return;
      }

      setPreviewAuthLoading(false);
      resetPreviewAuthError(message);

      if (previewAuthAccountInput) {
        previewAuthAccountInput.disabled = false;
        previewAuthAccountInput.value = previewState.account || "";
      }
      if (previewAuthPasswordInput) {
        previewAuthPasswordInput.disabled = false;
        previewAuthPasswordInput.value = previewState.password || "";
      }

      previewAuthBackdrop.classList.add("is-active");
      previewAuthBackdrop.setAttribute("aria-hidden", "false");
      setTimeout(() => {
        if (focusPassword && previewAuthPasswordInput) {
          previewAuthPasswordInput.focus();
          previewAuthPasswordInput.select();
        } else if (previewAuthAccountInput) {
          previewAuthAccountInput.focus();
          previewAuthAccountInput.select();
        }
      }, 10);
    }

    async function attemptPreviewWithCredentials(creds, options = {}) {
      const {
        promptOnAuthFailure = false,
        alertOnFailure = true,
      } = options;
      const ip = previewState.ip;
      if (!ip) {
        return { ok: false, code: "BAD_INPUT", message: "缺少攝影機 IP 位址" };
      }

      const account =
        typeof creds.account === "string" ? creds.account.trim() : "";
      const password =
        typeof creds.password === "string" ? creds.password : "";

      previewState.account = account;
      previewState.password = password;

      const payload = {
        ip,
        account,
        password,
      };

      let res;
      try {
        res = await fetch(PREVIEW_PROBE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF,
          },
          body: JSON.stringify(payload),
        });
      } catch (err) {
        const message =
          err && err.message ? err.message : "無法連接攝影機";
        if (previewBackdrop?.classList.contains("is-active")) {
          hidePreviewLoading();
          setPreviewInlineError(message);
        }
        if (alertOnFailure && !promptOnAuthFailure) {
          alert(message);
        }
        return { ok: false, code: "NETWORK", message };
      }

      let data = {};
      try {
        data = await res.json();
      } catch (err) {
        data = {};
      }

      if (!res.ok || !data.ok) {
        const code = data.code || "STREAM_ERROR";
        const message = data.error || "無法連接攝影機";
        if (code === "AUTH_REQUIRED" && promptOnAuthFailure) {
          if (previewBackdrop?.classList.contains("is-active")) {
            closePreviewModal();
          }
          openPreviewAuthModal({ message, focusPassword: Boolean(account) });
        } else if (alertOnFailure) {
          alert(message);
          if (previewBackdrop?.classList.contains("is-active")) {
            hidePreviewLoading();
            setPreviewInlineError(message);
          }
        } else if (previewBackdrop?.classList.contains("is-active")) {
          hidePreviewLoading();
          setPreviewInlineError(message);
        }
        return { ok: false, code, message };
      }

      if (
        previewAuthBackdrop &&
        previewAuthBackdrop.classList.contains("is-active")
      ) {
        closePreviewAuthModal();
      }
      if (!previewBackdrop?.classList.contains("is-active")) {
        if (previewState.dismissedByUser) {
          return { ok: true };
        }
        openPreviewModal();
      } else {
        showPreviewLoading();
        setPreviewInlineError();
      }
      startPreviewWebRTC();
      return { ok: true };
    }

    function requestPreview(ip, mac, name) {
      const ipClean = sanitizeIp(ip);
      if (!ipClean) {
        alert("缺少攝影機 IP，無法預覽。");
        return;
      }
      previewState.ip = ipClean;
      previewState.mac = sanitizeMac(mac);
      previewState.name =
        typeof name === "string" && name.trim() ? name.trim() : "IPC";
      previewState.account = "";
      previewState.password = "";
      previewState.streamUrl = "";
      previewState.streamActive = false;
      previewState.firstFrameLoaded = false;
      previewState.dismissedByUser = false;

      openPreviewModal();

      attemptPreviewWithCredentials(
        { account: "", password: "" },
        { promptOnAuthFailure: true, alertOnFailure: true }
      );
    }

    function resetCamModalError(message = "") {
      if (!camModalErrorBox) {
        return;
      }
      if (message) {
        camModalErrorBox.textContent = message;
        camModalErrorBox.hidden = false;
      } else {
        camModalErrorBox.textContent = "";
        camModalErrorBox.hidden = true;
      }
    }

    function closeCamModal() {
      if (!camModalBackdrop) {
        return;
      }
      camModalBackdrop.classList.remove("is-active");
      camModalBackdrop.setAttribute("aria-hidden", "true");
      camModalSubmitting = false;
      camModalState = { deviceName: "" };
      resetCamModalError();
      if (camModalForm) {
        camModalForm.reset();
      }
      if (camModalSubmitBtn) {
        camModalSubmitBtn.disabled = false;
        camModalSubmitBtn.textContent = camModalSubmitDefault;
      }
    }

    function openCamModal({ ip = "", mac = "", name = "" } = {}) {
      const ipClean = sanitizeIp(ip);
      const macClean = sanitizeMac(mac);
      const deviceName = typeof name === "string" ? name.trim() : "";

      if (!camModalBackdrop || !camModalForm) {
        const customNameInput =
          window.prompt("請輸入攝影機名稱", deviceName || "IPC") || "";
        const accountInput = window.prompt("選填：攝影機帳號", "") || "";
        const passwordInput = window.prompt("選填：攝影機密碼", "") || "";
        performCameraBind({
          ip: ipClean,
          mac: macClean,
          deviceName,
          customName: customNameInput,
          account: accountInput,
          password: passwordInput,
        })
          .then((result) => {
            if (result.alreadyBound) {
              alert("這台攝影機已經綁定在列表中。");
            }
          })
          .catch((err) => {
            alert("新增失敗：" + err.message);
          });
        return;
      }

      camModalState = { deviceName };
      camModalSubmitting = false;
      if (camModalForm) {
        camModalForm.reset();
      }
      resetCamModalError();

      if (camModalIpInput) camModalIpInput.value = ipClean;
      if (camModalMacInput) camModalMacInput.value = macClean;
      if (camModalIpcNameInput) camModalIpcNameInput.value = deviceName;
      if (camModalCustomNameInput)
        camModalCustomNameInput.value = deviceName || "IPC";
      if (camModalAccountInput) camModalAccountInput.value = "";
      if (camModalPasswordInput) camModalPasswordInput.value = "";
      if (camModalIpDisplay) camModalIpDisplay.textContent = ipClean || "—";
      if (camModalMacDisplay) camModalMacDisplay.textContent = macClean || "—";
      if (camModalSubmitBtn) {
        camModalSubmitBtn.disabled = false;
        camModalSubmitBtn.textContent = camModalSubmitDefault;
      }

      camModalBackdrop.classList.add("is-active");
      camModalBackdrop.setAttribute("aria-hidden", "false");

      setTimeout(() => {
        if (camModalCustomNameInput) {
          camModalCustomNameInput.focus();
          if (camModalCustomNameInput.value) {
            camModalCustomNameInput.select();
          }
        }
      }, 10);
    }

    if (camModalCancelBtn) {
      camModalCancelBtn.addEventListener("click", (event) => {
        event.preventDefault();
        closeCamModal();
      });
    }

    if (camModalBackdrop) {
      camModalBackdrop.addEventListener("click", (event) => {
        if (event.target === camModalBackdrop) {
          closeCamModal();
        }
      });
    }

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Escape") {
        return;
      }
      if (previewAuthBackdrop?.classList.contains("is-active") && !previewAuthSubmitting) {
        closePreviewAuthModal();
        return;
      }
      if (previewBackdrop?.classList.contains("is-active")) {
        closePreviewModal({ dismissedByUser: true });
        return;
      }
      if (camModalBackdrop?.classList.contains("is-active")) {
        closeCamModal();
      }
    });

    if (previewCloseBtn) {
      previewCloseBtn.addEventListener("click", () => {
        closePreviewModal({ dismissedByUser: true });
      });
    }

    if (previewBackdrop) {
      previewBackdrop.addEventListener("click", (event) => {
        if (event.target === previewBackdrop) {
          closePreviewModal({ dismissedByUser: true });
        }
      });
    }

    if (previewVideoEl) {
      const handleStreamReady = () => {
        markPreviewReady();
      };

      previewVideoEl.addEventListener("loadeddata", handleStreamReady);
      previewVideoEl.addEventListener("playing", handleStreamReady);

      const handleBuffering = () => {
        if (!previewState.streamActive || previewState.firstFrameLoaded) {
          return;
        }
        showPreviewLoading();
      };

      previewVideoEl.addEventListener("waiting", handleBuffering);
      previewVideoEl.addEventListener("stalled", handleBuffering);

      previewVideoEl.addEventListener("error", () => {
        if (!previewState.streamActive) {
          return;
        }
        stopPreviewStream();
        hidePreviewLoading();
        setPreviewInlineError("無法連接攝影機");
      });
    }

    if (previewAuthCancelBtn) {
      previewAuthCancelBtn.addEventListener("click", () => {
        closePreviewAuthModal();
      });
    }

    if (previewAuthBackdrop) {
      previewAuthBackdrop.addEventListener("click", (event) => {
        if (event.target === previewAuthBackdrop && !previewAuthSubmitting) {
          closePreviewAuthModal();
        }
      });
    }

    if (previewAuthForm) {
      previewAuthForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (previewAuthSubmitting) {
          return;
        }
        const account = previewAuthAccountInput
          ? previewAuthAccountInput.value.trim()
          : "";
        const password = previewAuthPasswordInput
          ? previewAuthPasswordInput.value
          : "";
        setPreviewAuthLoading(true);
        resetPreviewAuthError();
        const result = await attemptPreviewWithCredentials(
          { account, password },
          { promptOnAuthFailure: false, alertOnFailure: false }
        );
        setPreviewAuthLoading(false);
        if (!result.ok) {
          resetPreviewAuthError(result.message || "無法連接攝影機");
        }
      });
    }

    async function performCameraBind({
      ip,
      mac,
      deviceName = "",
      customName = "",
      account = "",
      password = "",
    }) {
      const ipClean = sanitizeIp(ip);
      const macClean = sanitizeMac(mac);
      const customNameClean = typeof customName === "string" ? customName.trim() : "";
      const finalCustomName = customNameClean || "IPC";
      const accountClean = typeof account === "string" ? account.trim() : "";
      let passwordValue = "";
      if (typeof password === "string") {
        passwordValue = password;
      } else if (password !== undefined && password !== null) {
        passwordValue = String(password);
      }
      const deviceNameClean = typeof deviceName === "string" ? deviceName.trim() : "";

      if (!ipClean || !macClean) {
        throw new Error("缺少攝影機連線資訊");
      }

      const fallbackItem = {
        ip: ipClean,
        mac: macClean,
        name: finalCustomName,
        is_bound: true,
      };

      const payload = {
        ip_address: ipClean,
        mac_address: macClean,
        ipc_name: deviceNameClean || finalCustomName,
        custom_name: finalCustomName,
        ipc_account: accountClean,
        ipc_password: passwordValue,
      };

      const response = await fetch("{% url 'api_cameras_bind' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": CSRF,
        },
        body: JSON.stringify(payload),
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(data.error || "HTTP " + response.status);
      }

      if (data.ok) {
        applyBoundState(data.item, fallbackItem);
        return { ok: true };
      }

      if (data.code === "ALREADY_BOUND") {
        applyBoundState(data.item, fallbackItem);
        return {
          ok: false,
          alreadyBound: true,
          message: data.error || "",
        };
      }

      throw new Error(data.error || "新增失敗");
    }

    if (camModalForm) {
      camModalForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (camModalSubmitting) {
          return;
        }
        resetCamModalError();
        camModalSubmitting = true;

        if (camModalSubmitBtn) {
          camModalSubmitBtn.disabled = true;
          camModalSubmitBtn.textContent = camModalSubmitProcessingText;
        }

        const ip = camModalIpInput ? camModalIpInput.value : "";
        const mac = camModalMacInput ? camModalMacInput.value : "";
        const deviceName =
          camModalIpcNameInput && camModalIpcNameInput.value
            ? camModalIpcNameInput.value
            : camModalState.deviceName;
        const customName = camModalCustomNameInput ? camModalCustomNameInput.value : "";
        const account = camModalAccountInput ? camModalAccountInput.value : "";
        const password = camModalPasswordInput ? camModalPasswordInput.value : "";

        try {
          const result = await performCameraBind({
            ip,
            mac,
            deviceName,
            customName,
            account,
            password,
          });
          if (result.alreadyBound) {
            alert("這台攝影機已經綁定在列表中。");
          }
          closeCamModal();
        } catch (err) {
          resetCamModalError(err.message || "新增失敗");
          if (camModalSubmitBtn) {
            camModalSubmitBtn.disabled = false;
            camModalSubmitBtn.textContent = camModalSubmitDefault;
          }
          camModalSubmitting = false;
        }
      });
    }

    const ICON_ADD =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
    const ICON_PREVIEW =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M12 6c5.25 0 9.75 6 9.75 6s-4.5 6-9.75 6S2.25 12 2.25 12s4.5-6 9.75-6Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="2.6" stroke="currentColor" stroke-width="1.6"/></svg>';
    const ICON_CHECK =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="m5 12 4 4 10-10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    const ICON_TRASH =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M3 6h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
    const ICON_STATUS_DEFAULT =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Z" stroke="currentColor" stroke-width="1.4" opacity=".6"/><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.4" opacity=".6"/></svg>';
    const ICON_STATUS_ERROR =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><circle cx="12" cy="16.5" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.4" opacity=".6"/></svg>';
    const ICON_STATUS_BOUND_EMPTY =
      '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.4" opacity=".6"/><path d="M8 12h8" stroke="currentColor" stroke-width="1.4" opacity=".6"/></svg>';

    function createIconElement(svgMarkup) {
      const tpl = document.createElement("template");
      tpl.innerHTML = svgMarkup.trim();
      return tpl.content.firstElementChild;
    }

    function sanitizeIp(value) {
      return typeof value === "string" ? value.trim() : "";
    }

    function sanitizeMac(value) {
      return typeof value === "string"
        ? value.replace(/-/g, ":").trim().toUpperCase()
        : "";
    }

    function normalizeRow(row) {
      if (!row || typeof row !== "object") {
        return { ip: "", mac: "", name: "IPC", is_bound: Boolean(row && row.is_bound) };
      }
      const ip = sanitizeIp(row.ip);
      const mac = sanitizeMac(row.mac);
      const name =
        typeof row.name === "string" && row.name.trim()
          ? row.name.trim()
          : "IPC";
      return {
        ip,
        mac,
        name,
        is_bound: Boolean(row.is_bound),
      };
    }

    function compareIpValues(a, b) {
      const parse = (value) => {
        if (!value) return null;
        const parts = value.split(".");
        if (parts.length !== 4) return null;
        const nums = parts.map((part) => {
          const n = Number(part);
          return Number.isInteger(n) && n >= 0 && n <= 255 ? n : null;
        });
        return nums.some((n) => n === null) ? null : nums;
      };
      const pa = parse(a);
      const pb = parse(b);
      if (pa && pb) {
        for (let i = 0; i < pa.length; i += 1) {
          if (pa[i] !== pb[i]) {
            return pa[i] - pb[i];
          }
        }
        return 0;
      }
      if (pa && !pb) return -1;
      if (!pa && pb) return 1;
      return (a || "").localeCompare(b || "");
    }

    let searchRows = [];
    let boundRows = [];

    function sortSearchRows() {
      searchRows.sort((a, b) => {
        if (a.is_bound !== b.is_bound) {
          return a.is_bound ? 1 : -1;
        }
        const ipCmp = compareIpValues(a.ip, b.ip);
        if (ipCmp !== 0) return ipCmp;
        return (a.mac || "").localeCompare(b.mac || "");
      });
    }

    function sortBoundRows() {
      boundRows.sort((a, b) => {
        const ipCmp = compareIpValues(a.ip, b.ip);
        if (ipCmp !== 0) return ipCmp;
        return (a.mac || "").localeCompare(b.mac || "");
      });
    }

    function setSearchRows(rows) {
      if (Array.isArray(rows)) {
        searchRows = rows.map((row) => normalizeRow(row));
        sortSearchRows();
      } else {
        searchRows = [];
      }
    }

    function setBoundRows(rows) {
      if (Array.isArray(rows)) {
        boundRows = rows.map((row) => {
          const normalized = normalizeRow(row);
          normalized.is_bound = true;
          return normalized;
        });
        sortBoundRows();
      } else {
        boundRows = [];
      }
    }

    function upsertBoundRow(item) {
      const normalized = normalizeRow({ ...item, is_bound: true });
      if (!normalized.ip && !normalized.mac) {
        return;
      }
      let updated = false;
      boundRows = boundRows.map((row) => {
        if (
          (normalized.mac && row.mac === normalized.mac) ||
          (!normalized.mac && normalized.ip && row.ip === normalized.ip)
        ) {
          updated = true;
          return { ...normalized };
        }
        return row;
      });
      if (!updated) {
        boundRows.push({ ...normalized });
      }
      sortBoundRows();
      renderBoundRows();
    }

    function removeBoundRow(item) {
      const normalized = normalizeRow(item);
      const targetMac = normalized.mac;
      const targetIp = normalized.ip;
      boundRows = boundRows.filter((row) => {
        if (targetMac && row.mac === targetMac) return false;
        if (!targetMac && targetIp && row.ip === targetIp) return false;
        return true;
      });
      sortBoundRows();
      renderBoundRows();
    }

    function updateSearchBinding(item, isBound) {
      const normalized = normalizeRow(item);
      const targetMac = normalized.mac;
      const targetIp = normalized.ip;
      let found = false;
      searchRows = searchRows.map((row) => {
        const same =
          (targetMac && row.mac === targetMac) ||
          (!targetMac && targetIp && row.ip === targetIp);
        if (!same) return row;
        found = true;
        const next = { ...row, is_bound: isBound };
        if (isBound && normalized.name) {
          next.name = normalized.name;
        }
        return next;
      });
      if (!found && isBound) {
        const toAdd = { ...normalized, is_bound: true };
        searchRows.push(toAdd);
      }
      sortSearchRows();
      if (isBound) {
        hasSearched = true;
      }
      renderSearchRows();
    }

    function applyBoundState(item, fallback) {
      const fallbackName =
        (item && typeof item.name === "string" && item.name.trim()) ||
        (fallback && typeof fallback.name === "string" && fallback.name.trim()) ||
        (fallback && typeof fallback.ipc_name === "string" && fallback.ipc_name.trim()) ||
        "IPC";
      const merged = {
        ip: (item && item.ip) || (fallback && fallback.ip) || "",
        mac: (item && item.mac) || (fallback && fallback.mac) || "",
        name: fallbackName,
        is_bound: true,
      };
      upsertBoundRow(merged);
      updateSearchBinding(merged, true);
    }

    function applyUnboundState(item, fallback) {
      const merged = {
        ip: (item && item.ip) || (fallback && fallback.ip) || "",
        mac: (item && item.mac) || (fallback && fallback.mac) || "",
        is_bound: false,
      };
      removeBoundRow(merged);
      updateSearchBinding(merged, false);
    }

    function buildStatusRow(message, { variant = "default" } = {}) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "empty-state";
      if (variant === "error") {
        td.dataset.error = "true";
      }
      const icon =
        variant === "error"
          ? createIconElement(ICON_STATUS_ERROR)
          : createIconElement(ICON_STATUS_DEFAULT);
      td.appendChild(icon);
      td.appendChild(document.createTextNode(" " + message));
      tr.appendChild(td);
      return tr;
    }

    function buildResultRow(row, index) {
      const tr = document.createElement("tr");
      if (row.is_bound) {
        tr.classList.add("is-bound");
      }

      const numTd = document.createElement("td");
      numTd.className = "num";
      numTd.textContent = String(index + 1);
      tr.appendChild(numTd);

      const ipTd = document.createElement("td");
      const ipChip = document.createElement("span");
      ipChip.className = "chip mono";
      const dot = document.createElement("span");
      dot.className = "dot";
      dot.setAttribute("aria-hidden", "true");
      ipChip.appendChild(dot);
      ipChip.appendChild(
        document.createTextNode(row.ip && row.ip.trim() ? row.ip : "—")
      );
      ipTd.appendChild(ipChip);
      tr.appendChild(ipTd);

      const macTd = document.createElement("td");
      const macChip = document.createElement("span");
      macChip.className = "chip mono";
      macChip.textContent = row.mac && row.mac.trim() ? row.mac : "—";
      macTd.appendChild(macChip);
      tr.appendChild(macTd);

      const nameTd = document.createElement("td");
      nameTd.appendChild(
        document.createTextNode(row.name && row.name.trim() ? row.name : "IPC")
      );
      if (row.is_bound) {
        const badge = document.createElement("span");
        badge.className = "status-badge";
        badge.textContent = "已綁定";
        nameTd.appendChild(badge);
      }
      tr.appendChild(nameTd);

      const actionTd = document.createElement("td");
      actionTd.className = "actions";
      const previewBtn = document.createElement("button");
      previewBtn.className = "action-btn";
      previewBtn.type = "button";
      previewBtn.innerHTML = ICON_PREVIEW + "預覽";
      previewBtn.addEventListener("click", () =>
        requestPreview(row.ip || "", row.mac || "", row.name || "")
      );
      actionTd.appendChild(previewBtn);
      if (row.is_bound) {
        const btn = document.createElement("button");
        btn.className = "action-btn";
        btn.disabled = true;
        btn.innerHTML = ICON_CHECK + "已綁定";
        actionTd.appendChild(btn);
      } else {
        const btn = document.createElement("button");
        btn.className = "action-btn";
        btn.type = "button";
        btn.innerHTML = ICON_ADD + "添加";
        btn.addEventListener("click", () =>
          addCam(row.ip || "", row.mac || "", row.name || "")
        );
        actionTd.appendChild(btn);
      }
      tr.appendChild(actionTd);

      return tr;
    }

    function buildBoundEmptyRow() {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "empty-state";
      td.appendChild(createIconElement(ICON_STATUS_BOUND_EMPTY));
      td.appendChild(document.createTextNode(" 尚未綁定任何攝影機"));
      tr.appendChild(td);
      return tr;
    }

    function buildBoundRow(row, index) {
      const tr = document.createElement("tr");

      const numTd = document.createElement("td");
      numTd.className = "num";
      numTd.textContent = String(index + 1);
      tr.appendChild(numTd);

      const ipTd = document.createElement("td");
      const ipChip = document.createElement("span");
      ipChip.className = "chip mono";
      const dot = document.createElement("span");
      dot.className = "dot";
      dot.setAttribute("aria-hidden", "true");
      ipChip.appendChild(dot);
      ipChip.appendChild(
        document.createTextNode(row.ip && row.ip.trim() ? row.ip : "—")
      );
      ipTd.appendChild(ipChip);
      tr.appendChild(ipTd);

      const macTd = document.createElement("td");
      const macChip = document.createElement("span");
      macChip.className = "chip mono";
      macChip.textContent = row.mac && row.mac.trim() ? row.mac : "—";
      macTd.appendChild(macChip);
      tr.appendChild(macTd);

      const nameTd = document.createElement("td");
      nameTd.textContent = row.name && row.name.trim() ? row.name : "IPC";
      tr.appendChild(nameTd);

      const actionTd = document.createElement("td");
      actionTd.className = "actions";
      const btn = document.createElement("button");
      btn.className = "action-btn danger";
      btn.type = "button";
      btn.innerHTML = ICON_TRASH + "刪除";
      btn.addEventListener("click", () =>
        delCam(row.mac || "", row.ip || "")
      );
      actionTd.appendChild(btn);
      tr.appendChild(actionTd);

      return tr;
    }

    function renderSearchRows(rows, state = {}) {
      if (!searchTableBody) return;
      const { loading = false, error = "" } = state;
      if (!loading && !error && Array.isArray(rows)) {
        setSearchRows(rows);
        if (rows.length) {
          hasSearched = true;
        }
      }
      searchTableBody.innerHTML = "";
      if (loading) {
        searchTableBody.appendChild(
          buildStatusRow("掃描中，請稍候…", { variant: "loading" })
        );
        return;
      }
      if (error) {
        searchTableBody.appendChild(
          buildStatusRow(error, { variant: "error" })
        );
        return;
      }
      sortSearchRows();
      if (!searchRows.length) {
        const message = hasSearched
          ? "未找到任何裝置"
          : "請按「搜尋攝影機」進行搜尋";
        searchTableBody.appendChild(buildStatusRow(message));
        return;
      }
      searchRows.forEach((row, index) => {
        searchTableBody.appendChild(buildResultRow(row, index));
      });
    }

    function renderBoundRows(rows) {
      if (!boundTableBody) return;
      if (Array.isArray(rows)) {
        setBoundRows(rows);
      }
      boundTableBody.innerHTML = "";
      if (!boundRows.length) {
        boundTableBody.appendChild(buildBoundEmptyRow());
        return;
      }
      sortBoundRows();
      boundRows.forEach((row, index) => {
        boundTableBody.appendChild(buildBoundRow(row, index));
      });
    }

    setSearchRows(initialSearchRows);
    setBoundRows(initialBoundRows);
    hasSearched = hasSearched || searchRows.length > 0;
    renderSearchRows();
    renderBoundRows();

    if (typeof window.previewCam !== "function") {
      window.previewCam = function (ip, mac, name) {
        requestPreview(ip, mac, name);
      };
    }

    if (typeof window.refreshSearch !== "function") {
      window.refreshSearch = function () {
        location.reload();
      };
    }

    if (typeof window.addCam !== "function") {
      window.addCam = function (ip, mac, name) {
        const ipClean = sanitizeIp(ip);
        const macClean = sanitizeMac(mac);
        const nameClean = typeof name === "string" ? name.trim() : "";
        openCamModal({
          ip: ipClean,
          mac: macClean,
          name: nameClean,
        });
      };
    }

    window.scanCameras = async function () {
      if (isScanning) return;
      isScanning = true;
      hasSearched = true;
      renderSearchRows([], { loading: true });
      if (scanBtn) {
        scanBtn.disabled = true;
      }
      try {
        const res = await fetch("{% url 'api_cameras_scan' %}", {
          method: "GET",
          headers: {
            Accept: "application/json",
          },
          credentials: "same-origin",
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        if (!data.ok) {
          throw new Error(data.error || "掃描失敗");
        }
        const rows = Array.isArray(data.results) ? data.results : [];
        renderSearchRows(rows);
      } catch (err) {
        renderSearchRows([], { error: "掃描失敗：" + err.message });
      } finally {
        isScanning = false;
        if (scanBtn) {
          scanBtn.disabled = false;
        }
      }
    };

    if (typeof window.delCam !== "function") {
      window.delCam = async function (mac, ip = "") {
        if (!confirm("確定要刪除這台攝影機嗎？")) return;
        const macClean = sanitizeMac(mac);
        const ipClean = sanitizeIp(ip);
        const payload = {};
        if (macClean) {
          payload.mac_address = macClean;
        }
        if (ipClean && !payload.mac_address) {
          payload.ip_address = ipClean;
        }
        const fallbackItem = {
          ip: ipClean,
          mac: macClean,
        };
        try {
          const res = await fetch("{% url 'api_cameras_unbind' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": CSRF,
            },
            body: JSON.stringify(payload),
          });
          const j = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(j.error || "HTTP " + res.status);
          if (j.ok) {
            applyUnboundState(j.item, fallbackItem);
          } else {
            alert("刪除失敗：" + (j.error || JSON.stringify(j)));
          }
        } catch (err) {
          alert("請求失敗：" + err.message);
        }
      };
    }
  })();
</script>
{% endblock %}
