{% extends "ui/base.html" %}
{% block title %}儀表板{% endblock %}
{% block header %}系統效能監控{% endblock %}

{% block content %}
<div class="card">
  <h3>CPU</h3>
  <p>使用率：<strong id="cpuPercent">--</strong>%</p>
  <div style="height:10px;border-radius:8px;background:color-mix(in oklab, var(--glass-bg) 70%, transparent);border:1px solid var(--glass-border);overflow:hidden">
    <div id="cpuBar" style="height:100%;width:0%;background:linear-gradient(90deg, var(--brand), color-mix(in oklab, var(--brand) 70%, white))"></div>
  </div>
</div>

<div class="card">
  <h3>記憶體</h3>
  <p><strong id="ramUsed">--</strong> / <span id="ramTotal">--</span> MB（<span id="ramPercent">--</span>%）</p>
  <div style="height:10px;border-radius:8px;background:color-mix(in oklab, var(--glass-bg) 70%, transparent);border:1px solid var(--glass-border);overflow:hidden">
    <div id="ramBar" style="height:100%;width:0%;background:linear-gradient(90deg, var(--brand), color-mix(in oklab, var(--brand) 70%, white))"></div>
  </div>
</div>

<div class="card">
  <h3>磁碟</h3>
  <p><strong id="diskUsed">--</strong> / <span id="diskTotal">--</span> GB（<span id="diskPercent">--</span>%）</p>
  <div style="height:10px;border-radius:8px;background:color-mix(in oklab, var(--glass-bg) 70%, transparent);border:1px solid var(--glass-border);overflow:hidden">
    <div id="diskBar" style="height:100%;width:0%;background:linear-gradient(90deg, var(--brand), color-mix(in oklab, var(--brand) 70%, white))"></div>
  </div>
</div>

<div class="card">
  <h3>溫度</h3>
  <p id="piTemp">--</p>
</div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const cpuPercent = $("cpuPercent"), cpuBar = $("cpuBar");
  const ramUsed = $("ramUsed"), ramTotal = $("ramTotal"), ramPercent = $("ramPercent"), ramBar = $("ramBar");
  const diskUsed = $("diskUsed"), diskTotal = $("diskTotal"), diskPercent = $("diskPercent"), diskBar = $("diskBar");
  const piTemp = $("piTemp");

  async function pull() {
    try {
      const res = await fetch("{% url 'api_metrics' %}", {cache: "no-store"});
      if (!res.ok) throw new Error(res.status);
      const d = await res.json();

      // CPU
      const c = Math.round(d.cpu.percent);
      cpuPercent.textContent = c;
      cpuBar.style.width = Math.min(100, c) + "%";

      // RAM
      ramUsed.textContent = d.ram.used_mb;
      ramTotal.textContent = d.ram.total_mb;
      ramPercent.textContent = Math.round(d.ram.percent);
      ramBar.style.width = Math.min(100, d.ram.percent) + "%";

      // Disk
      diskUsed.textContent = d.disk.used_gb;
      diskTotal.textContent = d.disk.total_gb;
      const dp = Math.round(d.disk.percent);
      if (document.getElementById("diskPercent")) {
        document.getElementById("diskPercent").textContent = dp;
      }
      diskBar.style.width = Math.min(100, dp) + "%";

      // Temp
      piTemp.textContent = d.temperature;

    } catch (e) {
      // 簡單退避：顯示 N/A，但不中斷循環
      console.warn("metrics fetch failed:", e);
    }
  }

  // 先拉一次，之後每 3 秒更新
  pull();
  setInterval(pull, 3000);
})();
</script>
{% endblock %}