{% extends "ui/base.html" %}
{% block title %}修改登入密碼{% endblock %}
{% block header %}修改登入密碼{% endblock %}

{% block content %}
<div class="card">
  <form id="changePwdForm" method="post" style="display:flex; flex-direction:column; gap:12px; max-width:420px;">
    {% csrf_token %}

    <!-- 舊密碼 -->
    <div style="display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center; gap:8px;">
        <label for="old_password" style="width:80px; text-align:right;">舊密碼：</label>
        <input type="password" id="old_password" name="old_password" style="width:250px;">
      </div>
      <span id="err_old" style="color:#ef4444; font-size:0.9em; margin-left:88px;"></span>
    </div>

    <!-- 新密碼 -->
    <div style="display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center; gap:8px;">
        <label for="new_password1" style="width:80px; text-align:right;">新密碼：</label>
        <input type="password" id="new_password1" name="new_password1" style="width:250px;" autocomplete="new-password">
      </div>
      <span style="color:var(--muted); font-size:0.85em; margin-left:88px;">至少 6 碼，僅限英數（不可空白、符號、中文）</span>
      <span id="err_new1" style="color:#ef4444; font-size:0.9em; margin-left:88px;"></span>
    </div>


    <div style="display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center; gap:8px;">
        <label for="new_password2" style="width:80px; text-align:right;">再次輸入：</label>
        <input type="password" id="new_password2" name="new_password2" style="width:250px;" autocomplete="new-password">
      </div>
      <span id="err_new2" style="color:#ef4444; font-size:0.9em; margin-left:88px;"></span>
    </div>

    <button type="submit" class="btn" style="margin-left:88px; width:120px;">確認修改</button>
  </form>
</div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const form = $("changePwdForm");
  const oldPwd = $("old_password");
  const new1 = $("new_password1");
  const new2 = $("new_password2");

  const eOld = $("err_old");
  const eNew1 = $("err_new1");
  const eNew2 = $("err_new2");

  const reStrict = /^[A-Za-z0-9]{6,}$/;

  function setError(inputEl, errEl, msg){
    errEl.textContent = msg || "";
    if (msg) {
      inputEl.style.borderColor = "#ef4444";
      inputEl.style.boxShadow = "0 0 0 3px rgba(239,68,68,.2)";
    } else {
      inputEl.style.borderColor = "#22c55e"; // 綠色
      inputEl.style.boxShadow = "0 0 0 3px rgba(34,197,94,.25)";
    }
  }

  function vOld(){
    const v = oldPwd.value.trim();
    if (!v) { setError(oldPwd, eOld, "舊密碼不可為空"); return false; }
    setError(oldPwd, eOld, ""); return true;
  }

  function vNew1(){
    const v = new1.value.trim();
    if (!v) { setError(new1, eNew1, "新密碼不可為空"); return false; }
    if (!reStrict.test(v)) { setError(new1, eNew1, "至少 6 碼且僅限英數"); return false; }
    setError(new1, eNew1, ""); return true;
  }

  function vNew2(){
    const v1 = new1.value.trim();
    const v2 = new2.value.trim();
    if (!v2) { setError(new2, eNew2, "請再次輸入新密碼"); return false; }
    if (v1 !== v2) { setError(new2, eNew2, "兩次輸入的新密碼不一致"); return false; }
    setError(new2, eNew2, ""); return true;
  }

  // blur 檢查
  oldPwd.addEventListener("blur", vOld);
  new1.addEventListener("blur", vNew1);
  new2.addEventListener("blur", vNew2);

  // Enter 檢查
  [oldPwd, new1, new2].forEach(el => {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (el === oldPwd) vOld();
        if (el === new1) vNew1();
        if (el === new2) vNew2();
      }
    });
  });

  // submit 前檢查
  form.addEventListener("submit", (e) => {
    const ok = vOld() && vNew1() && vNew2();
    if (!ok) e.preventDefault();
  });
})();
</script>{% endblock %}