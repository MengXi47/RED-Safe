FROM eclipse-temurin:17-jdk-jammy AS build
ENV TZ=Asia/Taipei
WORKDIR /workspace

COPY mvnw .
COPY .mvn .mvn
COPY pom.xml .
COPY src src

RUN chmod +x mvnw \
    && ./mvnw -B clean package -DskipTests \
    && JAR_PATH=$(find target -maxdepth 1 -type f -name "*.jar" ! -name "*original*" | head -n 1) \
    && [ -n "$JAR_PATH" ] \
    && mv "$JAR_PATH" target/app.jar

FROM eclipse-temurin:17-jre-jammy
ENV TZ=Asia/Taipei

RUN useradd -m appuser

WORKDIR /app
COPY --from=build --chown=appuser:appuser /workspace/target/app.jar /app/app.jar

USER appuser

EXPOSE 30021 30022

ENTRYPOINT ["java","-XX:MaxRAMPercentage=75","-Duser.timezone=Asia/Taipei","-Dserver.port=30021","-Dgrpc.server.port=30022","-jar","/app/app.jar"]
